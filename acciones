local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local mouse = player:GetMouse()
local playerGui = player:WaitForChild("PlayerGui")

-- Variables generales
local currentTrack = nil 
local currentAnimId = nil 

local draggingSlider = false
local currentTransparency = 0
local lastAppliedTransparency = 0 
local originalTransparencies = {} 
local mapLoaded = false 

-- Variables de Target y Bring
local targetPlayer = nil 
local isTargeting = false 
local bringAllEnabled = false 

-- Variables de ESCANEO DE ITEMS
local itemScanEnabled = false
local HIGHLIGHT_NAME = "ESP_Highlight"
local TEXT_TAG_NAME = "ESP_TextTag"

-- Variables de FALSO NPC
local fakeNpcEnabled = false
local npcData = {} 
local lastNpcScan = 0
local lastNpcUpdate = 0
local NPC_MAX_WALKSPEED = 16.8
local NPC_UPDATE_FREQ = 0.05

-- IDs de Emotes
local ID_TORNADO = 135373056067761
local ID_SENTARSE = 71112973269174
local ID_BERRINCHE = 86339673982616
local ID_CUTE = 98695071641289
local ID_INVISIBLE = 113994067684875
local ID_FLOTANDO = 112389019631009
local ID_ESQUIAR = 76573949416065 

local misEmotes = {
	{Name = "Tornado (G)",  Id = ID_TORNADO},
	{Name = "Sentarse (F)", Id = ID_SENTARSE},
	{Name = "Berrinche (H)", Id = ID_BERRINCHE},
	{Name = "Cute (J)",      Id = ID_CUTE},
	{Name = "Invisible (K)", Id = ID_INVISIBLE},
	{Name = "Flotando (L)",  Id = ID_FLOTANDO},
	{Name = "Esquiar (M)",   Id = ID_ESQUIAR}
}

-- Ocultar men√∫ nativo
task.spawn(function()
	for i = 1, 10 do 
		pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.EmotesMenu, false) end)
		task.wait(0.5) 
	end
end)

-- --- FUNCIONES DE ANIMACI√ìN ---
local function toggleAnim(animId)
	if currentTrack then currentTrack:Stop(); currentTrack = nil end
	if currentAnimId == animId then currentAnimId = nil; return end
	currentAnimId = animId
	local hum = player.Character and player.Character:FindFirstChild("Humanoid")
	if hum then
		local animator = hum:FindFirstChild("Animator") or Instance.new("Animator", hum)
		local animation = Instance.new("Animation"); animation.AnimationId = "rbxassetid://"..tostring(animId)
		local s, t = pcall(function() return animator:LoadAnimation(animation) end)
		if s and t then currentTrack = t; t.Priority = Enum.AnimationPriority.Action; t.Looped = true; t:Play() end
	end
end

-- --- L√ìGICA DE ESCANEO DE √çTEMS ---
local function updateItemESP()
	for _, p in ipairs(Players:GetPlayers()) do
		if p == player then continue end
		local char = p.Character
		if char and char:FindFirstChild("Head") then
			-- Highlight
			local highlight = char:FindFirstChild(HIGHLIGHT_NAME)
			if itemScanEnabled then
				if not highlight then
					highlight = Instance.new("Highlight", char)
					highlight.Name = HIGHLIGHT_NAME
					highlight.FillColor = Color3.fromRGB(0, 255, 255)
					highlight.FillTransparency = 0.5
				end
			else
				if highlight then highlight:Destroy() end
			end

			-- Texto de √çtems
			local head = char.Head
			local textTag = head:FindFirstChild(TEXT_TAG_NAME)
			if itemScanEnabled then
				if not textTag then
					textTag = Instance.new("BillboardGui", head)
					textTag.Name = TEXT_TAG_NAME
					textTag.Size = UDim2.new(0, 200, 0, 100)
					textTag.AlwaysOnTop = true
					textTag.ExtentsOffset = Vector3.new(0, 3, 0)
					local tl = Instance.new("TextLabel", textTag)
					tl.Name = "ItemLabel"; tl.BackgroundTransparency = 1; tl.Size = UDim2.new(1, 0, 1, 0)
					tl.Font = Enum.Font.GothamBold; tl.TextColor3 = Color3.new(1, 1, 1); tl.TextSize = 12; tl.TextStrokeTransparency = 0
				end
				local items = {}
				for _, item in ipairs(p.Backpack:GetChildren()) do if item:IsA("Tool") then table.insert(items, "üì¶ "..item.Name) end end
				local equipped = char:FindFirstChildWhichIsA("Tool")
				if equipped then table.insert(items, "‚öîÔ∏è "..equipped.Name.." (Mano)") end
				textTag.ItemLabel.Text = #items > 0 and table.concat(items, "\n") or "[ Sin Items ]"
			else
				if textTag then textTag:Destroy() end
			end
		end
	end
end

local function removeAllItemVisuals()
	for _, p in ipairs(Players:GetPlayers()) do
		if p.Character then 
			if p.Character:FindFirstChild(HIGHLIGHT_NAME) then p.Character[HIGHLIGHT_NAME]:Destroy() end
			local h = p.Character:FindFirstChild("Head")
			if h and h:FindFirstChild(TEXT_TAG_NAME) then h[TEXT_TAG_NAME]:Destroy() end
		end
	end
end

-- --- INTERFAZ GR√ÅFICA (GUI) ---
local screenGui = Instance.new("ScreenGui", playerGui)
screenGui.Name = "System_Merged_Scanner"; screenGui.ResetOnSpawn = false; screenGui.IgnoreGuiInset = true

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Name = "TopContainer"; mainFrame.Size = UDim2.new(0, 110, 0, 32); mainFrame.Position = UDim2.new(0, 230, 0, 8); mainFrame.BackgroundTransparency = 1 

local toggleBtn = Instance.new("TextButton", mainFrame)
toggleBtn.Text = "ACCIONES"; toggleBtn.Size = UDim2.new(1, 0, 1, 0); toggleBtn.BackgroundColor3 = Color3.new(0,0,0); toggleBtn.BackgroundTransparency = 0.5; toggleBtn.TextColor3 = Color3.new(1,1,1); toggleBtn.Font = Enum.Font.GothamBold; toggleBtn.TextSize = 12
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(1, 0)

local listFrame = Instance.new("Frame", mainFrame)
listFrame.Name = "ListPanel"; listFrame.Size = UDim2.new(1, 20, 0, 0); listFrame.Position = UDim2.new(0, -10, 0, 38); listFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30); listFrame.Visible = false; listFrame.Active = true
Instance.new("UICorner", listFrame).CornerRadius = UDim.new(0, 8)
local layout = Instance.new("UIListLayout", listFrame); layout.HorizontalAlignment = Enum.HorizontalAlignment.Center; layout.Padding = UDim.new(0, 4)
Instance.new("UIPadding", listFrame).PaddingTop = UDim.new(0, 8)

-- Crear Botones
local function createButton(text, color, order, callback)
	local btn = Instance.new("TextButton", listFrame)
	btn.Text = text; btn.Size = UDim2.new(0.95, 0, 0, 30); btn.BackgroundColor3 = color; btn.BackgroundTransparency = 0.3; btn.TextColor3 = Color3.new(1,1,1); btn.Font = Enum.Font.GothamSemibold; btn.TextSize = 11; btn.LayoutOrder = order
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6); btn.MouseButton1Click:Connect(callback)
	return btn
end

-- Generar botones de emotes
for i, data in ipairs(misEmotes) do 
	createButton(data.Name, Color3.fromRGB(60, 60, 70), i, function() toggleAnim(data.Id) end) 
end

-- Botones de herramientas
local itemScanBtn = createButton("ESCANEO ITEMS (OFF)", Color3.fromRGB(0, 150, 200), 55, function() itemScanEnabled = not itemScanEnabled; if not itemScanEnabled then removeAllItemVisuals() end end)
local targetBtn = createButton("TARGET HITBOX", Color3.fromRGB(255, 100, 0), 60, function() isTargeting = not isTargeting; if not isTargeting then restoreAllPhysics() end end)
local bringAllBtn = createButton("BRING ALL (OFF)", Color3.fromRGB(160, 32, 240), 65, function() bringAllEnabled = not bringAllEnabled; if not bringAllEnabled then restoreAllPhysics() end end)

-- --- EVENTOS Y BUCLE ---
RunService.RenderStepped:Connect(function()
	updateItemESP()
	
	-- Actualizaci√≥n de Textos de Botones
	itemScanBtn.Text = itemScanEnabled and "ESCANEO ITEMS (ON)" or "ESCANEO ITEMS (OFF)"
	itemScanBtn.BackgroundColor3 = itemScanEnabled and Color3.fromRGB(0, 255, 100) or Color3.fromRGB(0, 150, 200)
	bringAllBtn.Text = bringAllEnabled and "BRING ALL (ON)" or "BRING ALL (OFF)"
    
    -- L√≥gica de Bring All / Target (Simplificada para el ejemplo)
    if bringAllEnabled then
        local myRoot = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if myRoot then
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    p.Character.HumanoidRootPart.CFrame = myRoot.CFrame * CFrame.new(0,0,-4)
                end
            end
        end
    end
end)

UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.F then toggleAnim(ID_SENTARSE)
	elseif input.KeyCode == Enum.KeyCode.G then toggleAnim(ID_TORNADO)
	elseif input.KeyCode == Enum.KeyCode.H then toggleAnim(ID_BERRINCHE)
	elseif input.KeyCode == Enum.KeyCode.J then toggleAnim(ID_CUTE)
	elseif input.KeyCode == Enum.KeyCode.K then toggleAnim(ID_INVISIBLE)
	elseif input.KeyCode == Enum.KeyCode.L then toggleAnim(ID_FLOTANDO)
	elseif input.KeyCode == Enum.KeyCode.M then toggleAnim(ID_ESQUIAR)
	end
end)

toggleBtn.MouseButton1Click:Connect(function() 
	listFrame.Visible = not listFrame.Visible 
	toggleBtn.Text = listFrame.Visible and "CERRAR" or "ACCIONES"
end)

listFrame.Size = UDim2.new(1, 20, 0, (#misEmotes + 4) * 35)
